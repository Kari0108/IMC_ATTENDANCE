<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMC ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo-placeholder {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .logo-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .login-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .input-field {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Dashboard Page Styles */
        .dashboard-container {
            display: none;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .navbar-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .navbar-logo-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .navbar-title {
            font-size: 22px;
            font-weight: 600;
            color: #2c3e50;
        }

        .logout-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .dashboard-content {
            padding: 40px 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 28px;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 40px;
        }

        .attendance-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        /* Camera Section Styles */
        .camera-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .camera-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto;
        }

        #cameraVideo {
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            background: #000;
        }

        #capturedImage {
            display: none;
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .camera-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .camera-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-camera-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .start-camera-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .capture-btn {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(253, 121, 168, 0.3);
        }

        .capture-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(253, 121, 168, 0.4);
        }

        .retake-btn {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
        }

        .retake-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(253, 203, 110, 0.4);
        }

        .attendance-btn {
            padding: 20px 40px;
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.3);
        }

        .attendance-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 184, 148, 0.4);
        }

        .attendance-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-message {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 30px;
            padding: 15px;
            border-radius: 10px;
        }

        .status-success {
            background: rgba(0, 184, 148, 0.1);
            color: #00b894;
            border: 1px solid rgba(0, 184, 148, 0.2);
        }

        .status-pending {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.2);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .current-time {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        /* Map Styles */
        #map {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .location-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        .location-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
            display: inline-block;
        }

        .location-status.success {
            background: rgba(0, 184, 148, 0.1);
            color: #00b894;
            border: 1px solid rgba(0, 184, 148, 0.2);
        }

        .location-status.error {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.2);
        }

        .camera-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .camera-status.success {
            background: rgba(0, 184, 148, 0.1);
            color: #00b894;
            border: 1px solid rgba(0, 184, 148, 0.2);
        }

        .camera-status.error {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.2);
        }

        /* Error/Loading messages */
        .error-message {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .loading-message {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar {
                padding: 15px 20px;
            }

            .navbar-title {
                font-size: 18px;
            }

            .dashboard-content {
                padding: 20px 15px;
            }

            .section-title {
                font-size: 24px;
            }

            .attendance-section, .camera-section {
                padding: 25px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .login-card {
                padding: 30px 25px;
            }

            .login-title {
                font-size: 20px;
            }

            .camera-controls {
                flex-direction: column;
                align-items: center;
            }

            .camera-btn {
                width: 200px;
            }

            #map {
                height: 150px;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<!-- Login Page -->
<div id="loginPage" class="login-container">
    <div class="login-card">

        <!-- Replace with actual image when available: -->
        <img src="indore.jpg" alt="IMC Logo" class="logo-image">

        <h1 class="login-title">IMC ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à</h1>
        <div class="input-group">
            <input type="tel" class="input-field" id="phoneNumber" placeholder="‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" required>
        </div>
        <button class="login-btn" onclick="handleLogin()">‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</button>

        <div id="loginMessage" style="margin-top: 15px; display: none;"></div>
    </div>
</div>

<!-- Dashboard Page -->
<div id="dashboardPage" class="dashboard-container">
    <nav class="navbar">
        <div class="navbar-logo">IMC</div>
        <h1 class="navbar-title">‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°</h1>
        <button class="logout-btn" onclick="handleLogout()">‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü</button>
    </nav>

    <div class="dashboard-content">
        <h2 class="section-title">‡§Ö‡§™‡§®‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</h2>

        <!-- Camera Section -->
        <div class="camera-section">
            <h3 style="font-size: 20px; margin-bottom: 20px; color: #2c3e50;">üì∏ ‡§´‡•ã‡§ü‡•ã ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç</h3>
            <div class="camera-container">
                <video id="cameraVideo" autoplay muted playsinline></video>
                <img id="capturedImage" alt="Captured Image">
                <canvas id="cameraCanvas" style="display: none;"></canvas>
            </div>

            <div id="cameraStatus" class="camera-status" style="display: none;"></div>

            <div class="camera-controls">
                <button id="startCameraBtn" class="camera-btn start-camera-btn" onclick="startCamera()">
                    üìπ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç
                </button>
                <button id="captureBtn" class="camera-btn capture-btn" onclick="capturePhoto()" style="display: none;">
                    üì∑ ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç
                </button>
                <button id="retakeBtn" class="camera-btn retake-btn" onclick="retakePhoto()" style="display: none;">
                    üîÑ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§≤‡•á‡§Ç
                </button>
            </div>
        </div>

        <!-- Attendance Section -->
        <div class="attendance-section">
            <button id="attendanceBtn" class="attendance-btn" onclick="markAttendance()" disabled>
                ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç
            </button>

            <div id="statusMessage" class="status-message status-pending">
                ‚ùå ‡§™‡§π‡§≤‡•á ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç, ‡§´‡§ø‡§∞ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <h3>‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡§Æ‡§Ø:</h3>
                    <div id="currentTime" class="current-time">10:42 AM</div>
                </div>

                <div class="info-card">
                    <h3>‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§•‡§æ‡§®</h3>
                    <div id="map"></div>
                    <div class="location-info">
                        <div id="locationText">‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</div>
                        <div id="locationStatus" class="location-status">üåç GPS ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
    let attendanceMarked = false;
    let photoTaken = false;
    let stream = null;
    let currentPhoneNumber = '';
    let capturedImageData = null;
    let map = null;
    let userMarker = null;
    let currentLocation = null;
    let locationMonitorInterval = null;

    // Variables to store original attendance location
    let originalLat = null;
    let originalLon = null;

    // Base URL for your API
    const API_BASE_URL = 'http://localhost:3000/api';

    // Show message function
    function showMessage(elementId, message, type = 'info') {
        const element = document.getElementById(elementId);
        if (!element) { // IMPORTANT: Add null check here
            console.error(`Error: Element with ID '${elementId}' not found for showMessage.`);
            return; // Exit if element doesn't exist to prevent crash
        }
        element.innerHTML = message;
        element.className = type === 'error' ? 'error-message' :
                          type === 'loading' ? 'loading-message' :
                          'status-message status-success';
        element.style.display = 'block';

        // Hide after 5 seconds unless it's an error
        if (type !== 'error') {
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
    }

    // Handle Login
    async function handleLogin() {
        const phoneNumber = document.getElementById('phoneNumber').value.trim();

        if (!phoneNumber) {
            showMessage('loginMessage', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç', 'error');
            return;
        }

        if (phoneNumber.length !== 10 || !/^\d{10}$/.test(phoneNumber)) {
            showMessage('loginMessage', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä 10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç', 'error');
            return;
        }

        try {
            showMessage('loginMessage', '‡§≤‡•â‡§ó‡§ø‡§® ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', 'loading');

            const response = await fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ phoneNumber: phoneNumber })
            });

            const result = await response.json();
            console.log('Login response:', result);

            if (response.ok && result.success) {
                currentPhoneNumber = phoneNumber;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboardPage').style.display = 'block';

                // Start the clock
                updateTime();
                setInterval(updateTime, 1000);

                // Initialize map and get location
                // Add a slight delay to ensure map div is rendered before Leaflet init
                setTimeout(() => {
                    initializeMap();
                    getCurrentLocation();
                }, 100);

                showMessage('loginMessage', `‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡§´‡§≤: ${result.user?.name || 'User'}`, 'success');
            } else {
                showMessage('loginMessage', result.message || '‡§≤‡•â‡§ó‡§ø‡§® ‡§µ‡§ø‡§´‡§≤', 'error');
            }
        } catch (error) {
            console.error('Login error:', error);
            // This specific error might occur if the backend is truly unreachable or sends malformed JSON
            showMessage('loginMessage', '‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§', 'error');
        }
    }

    // Handle Logout
    function handleLogout() {
        // Stop camera if running
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }

        // Clean up map
        if (map) {
            map.remove();
            map = null;
            userMarker = null;
        }

        // Clear location monitor interval
        if (locationMonitorInterval) {
            clearInterval(locationMonitorInterval);
            locationMonitorInterval = null;
        }

        document.getElementById('dashboardPage').style.display = 'none';
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('phoneNumber').value = '';
        const loginMessageElement = document.getElementById('loginMessage');
        if(loginMessageElement) { // Also add a check here for safety during logout
            loginMessageElement.style.display = 'none';
        }


        attendanceMarked = false;
        photoTaken = false;
        currentPhoneNumber = '';
        capturedImageData = null;
        currentLocation = null;
        originalLat = null;
        originalLon = null;

        // Reset UI elements
        resetCameraUI();
        updateAttendanceStatus();
    }

    // Initialize Map
    function initializeMap() {
        try {
            // Default location (Indore, India)
            const defaultLat = 22.7196;
            const defaultLng = 75.8577;

            // Check if map container is initialized (important for re-initialization on logout/login)
            const mapContainer = document.getElementById('map');
            if (mapContainer && mapContainer._leaflet_id) { // Ensure mapContainer exists before checking _leaflet_id
                map.remove(); // Remove existing map instance
            }

            // Initialize map centered on Indore
            map = L.map('map').setView([defaultLat, defaultLng], 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                timeout: 10000
            }).addTo(map);

            // Add default marker for Indore
            L.marker([defaultLat, defaultLng])
                .addTo(map)
                .bindPopup('‡§á‡§Ç‡§¶‡•å‡§∞, ‡§Æ‡§ß‡•ç‡§Ø ‡§™‡•ç‡§∞‡§¶‡•á‡§∂')
                .openPopup();

            console.log('‚úÖ Map initialized successfully');
        } catch (error) {
            console.error('Map initialization error:', error);
            const mapElement = document.getElementById('map');
            if(mapElement) { // Check before setting innerHTML
                mapElement.innerHTML = '<div class="error-message">‡§Æ‡•à‡§™ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ</div>';
            }
        }
    }

    // Get Current Location
    function getCurrentLocation() {
        if (!navigator.geolocation) {
            updateLocationStatus('‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ', 'error');
            return;
        }

        updateLocationStatus('‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...', 'success');

        navigator.geolocation.getCurrentPosition(
            function(position) {
                currentLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };

                console.log('‚úÖ Location obtained:', currentLocation);

                // Update map with user location
                updateMapWithUserLocation();
                updateLocationStatus('‡§∏‡•ç‡§•‡§æ‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü', 'success');
            },
            function(error) {
                let errorMessage = '‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = '‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•Ä ‡§ó‡§à';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = '‡§∏‡•ç‡§•‡§æ‡§® ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à';
                        break;
                    case error.TIMEOUT:
                        errorMessage = '‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§Ø ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§';
                        break;
                }
                updateLocationStatus(errorMessage, 'error');
                console.error('Geolocation error:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 60000
            }
        );
    }

    // Update Map with User Location
    function updateMapWithUserLocation() {
        if (!map || !currentLocation) return;

        try {
            const { latitude, longitude, accuracy } = currentLocation;

            // Center map on user location
            map.setView([latitude, longitude], 16);

            // Remove existing user marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }

            // Add user location marker
            userMarker = L.marker([latitude, longitude])
                .addTo(map)
                .bindPopup(`‡§Ü‡§™‡§ï‡§æ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§•‡§æ‡§®<br>‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ: ${accuracy.toFixed(0)} ‡§Æ‡•Ä‡§ü‡§∞`)
                .openPopup();

            // Add accuracy circle
            L.circle([latitude, longitude], {
                radius: accuracy,
                color: '#667eea',
                fillColor: '#667eea',
                fillOpacity: 0.1
            }).addTo(map);

            // Update location text
            updateLocationText(latitude, longitude);

            console.log('‚úÖ Map updated with user location');
        } catch (error) {
            console.error('Error updating map:', error);
        }
    }

    // Update Location Text (Reverse Geocoding)
    async function updateLocationText(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`);
            const data = await response.json();

            if (data && data.display_name) {
                const locationText = data.display_name.split(',').slice(0, 3).join(', ');
                document.getElementById('locationText').textContent = locationText;
            } else {
                document.getElementById('locationText').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        } catch (error) {
            console.error('Reverse geocoding error:', error);
            document.getElementById('locationText').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }
    }

    // Update Location Status
    function updateLocationStatus(message, type) {
        const statusElement = document.getElementById('locationStatus');
        if(statusElement) { // Check before setting properties
            statusElement.textContent = message;
            statusElement.className = `location-status ${type}`;
        }
    }

    // Start Camera
    async function startCamera() {
        try {
            const constraints = {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                }
            };

            stream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;

            // Update UI
            document.getElementById('startCameraBtn').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'inline-block';

            showCameraStatus('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ö‡§æ‡§≤‡•Ç ‡§π‡•ã ‡§ó‡§Ø‡§æ', 'success');

        } catch (error) {
            console.error('Camera access error:', error);
            showCameraStatus('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ: ' + error.message, 'error');
        }
    }

    // Capture Photo
    function capturePhoto() {
        try {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const capturedImage = document.getElementById('capturedImage');

            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert to base64 image data
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);

            // Display captured image
            capturedImage.src = capturedImageData;
            capturedImage.style.display = 'block';
            video.style.display = 'none';

            // Update UI
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';

            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            photoTaken = true;
            updateAttendanceStatus();
            showCameraStatus('‡§´‡•ã‡§ü‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§π‡•Å‡§à', 'success');

        } catch (error) {
            console.error('Photo capture error:', error);
            showCameraStatus('‡§´‡•ã‡§ü‡•ã ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ: ' + error.message, 'error');
        }
    }

    // Retake Photo
    function retakePhoto() {
        const video = document.getElementById('cameraVideo');
        const capturedImage = document.getElementById('capturedImage');

        // Reset UI
        capturedImage.style.display = 'none';
        video.style.display = 'block';
        document.getElementById('retakeBtn').style.display = 'none';
        document.getElementById('startCameraBtn').style.display = 'inline-block';

        // Clear captured data
        capturedImageData = null;
        photoTaken = false;
        updateAttendanceStatus();

        // Clear camera status
        document.getElementById('cameraStatus').style.display = 'none';
    }

    // Show Camera Status
    function showCameraStatus(message, type) {
        const statusElement = document.getElementById('cameraStatus');
        if(statusElement) { // Check before setting properties
            statusElement.textContent = message;
            statusElement.className = `camera-status ${type}`;
            statusElement.style.display = 'block';
        }
    }

    // Reset Camera UI
    function resetCameraUI() {
        const video = document.getElementById('cameraVideo');
        const capturedImage = document.getElementById('capturedImage');

        if(video) video.style.display = 'block';
        if(capturedImage) capturedImage.style.display = 'none';

        const startCameraBtn = document.getElementById('startCameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const cameraStatus = document.getElementById('cameraStatus');

        if(startCameraBtn) startCameraBtn.style.display = 'inline-block';
        if(captureBtn) captureBtn.style.display = 'none';
        if(retakeBtn) retakeBtn.style.display = 'none';
        if(cameraStatus) cameraStatus.style.display = 'none';
    }

    // Update Attendance Status
    function updateAttendanceStatus() {
        const attendanceBtn = document.getElementById('attendanceBtn');
        const statusMessage = document.getElementById('statusMessage');

        if(attendanceBtn) {
            if (attendanceMarked) {
                attendanceBtn.disabled = true;
                attendanceBtn.textContent = '‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à';
            } else if (photoTaken) {
                attendanceBtn.disabled = false;
            } else {
                attendanceBtn.disabled = true;
            }
        }

        if(statusMessage) {
            if (attendanceMarked) {
                statusMessage.className = 'status-message status-success';
                statusMessage.innerHTML = '‚úÖ ‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à';
            } else if (photoTaken) {
                statusMessage.className = 'status-message status-success';
                statusMessage.innerHTML = '‚úÖ ‡§´‡•ã‡§ü‡•ã ‡§≤‡•Ä ‡§ó‡§à - ‡§Ö‡§¨ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç';
            } else {
                statusMessage.className = 'status-message status-pending';
                statusMessage.innerHTML = '‚ùå ‡§™‡§π‡§≤‡•á ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç, ‡§´‡§ø‡§∞ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç';
            }
        }
    }

    // Mark Attendance
    async function markAttendance() {
        if (!photoTaken || !capturedImageData) {
            showMessage('statusMessage', '‡§™‡§π‡§≤‡•á ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç', 'error');
            return;
        }

        if (attendanceMarked) {
            showMessage('statusMessage', '‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§¶‡§∞‡•ç‡§ú ‡§π‡•à', 'error');
            return;
        }

        if (!currentLocation) {
            showMessage('statusMessage', '‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§', 'error');
            return;
        }

        try {
            showMessage('statusMessage', '‚è≥ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...', 'loading');

            const blob = await (await fetch(capturedImageData)).blob();
            const formData = new FormData();

            formData.append('selfie', blob, `selfie_${currentPhoneNumber}_${Date.now()}.jpg`);
            formData.append('phone_number', currentPhoneNumber);
            formData.append('latitude', currentLocation.latitude);
            formData.append('longitude', currentLocation.longitude);
            formData.append('accuracy', currentLocation.accuracy || 0);

            console.log('Sending attendance data via FormData...');

            const response = await fetch(`${API_BASE_URL}/mark-attendance`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            console.log('Attendance response:', result);

            if (response.ok && result.success) {
                attendanceMarked = true;
                originalLat = currentLocation.latitude;
                originalLon = currentLocation.longitude;

                if (locationMonitorInterval) {
                    clearInterval(locationMonitorInterval);
                }
                start10MinuteLocationMonitor();
                updateAttendanceStatus();
                showMessage('statusMessage', '‚úÖ ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à', 'success');
            } else {
                showMessage('statusMessage', result.message || '‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ', 'error');
            }

        } catch (error) {
            console.error('Attendance marking error:', error);
            showMessage('statusMessage', '‚ùå ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§', 'error');
        }
    }

    // Periodic 10-min location checker
    function start10MinuteLocationMonitor() {
        if (locationMonitorInterval) {
            clearInterval(locationMonitorInterval);
        }

        let monitoringAttempts = 0;
        const maxMonitoringAttempts = (2 * 60) / 10;

        locationMonitorInterval = setInterval(() => {
            if (monitoringAttempts >= maxMonitoringAttempts) {
                console.log('Location monitoring completed after 2 hours.');
                clearInterval(locationMonitorInterval);
                locationMonitorInterval = null;
                return;
            }

            if (!originalLat || !originalLon) {
                console.log('Original location not set for monitoring. Skipping check.');
                return;
            }

            navigator.geolocation.getCurrentPosition(pos => {
                const newLat = pos.coords.latitude;
                const newLon = pos.coords.longitude;

                const distance = getDistanceInMeters(originalLat, originalLon, newLat, newLon);
                console.log(`üìè Distance from start: ${distance.toFixed(2)}m (Attempt ${monitoringAttempts + 1}/${maxMonitoringAttempts})`);

                if (distance >= 500) {
                    showMessage('statusMessage', '‚ö†Ô∏è ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§Ü‡§™ 500 ‡§Æ‡•Ä‡§ü‡§∞ ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§¶‡•Ç‡§∞ ‡§π‡•à‡§Ç!', 'error');

                    fetch(`${API_BASE_URL}/location-alert`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            phone_number: currentPhoneNumber,
                            original_lat: originalLat,
                            original_lon: originalLon,
                            current_lat: newLat,
                            current_lon: newLon,
                            distance: distance.toFixed(2)
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Location deviation alert logged successfully.');
                        } else {
                            console.error('Failed to log location alert:', data.message);
                        }
                    })
                    .catch(err => console.error('Error sending location alert:', err));
                }
                monitoringAttempts++;
            }, (error) => {
                console.error('Geolocation error during monitoring:', error);
            }, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        }, 10 * 60 * 1000);
    }

    // Distance calculator using Haversine formula
    function getDistanceInMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = deg => (deg * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);

        const a = Math.sin(dLat / 2) ** 2 +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon / 2) ** 2;

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // Update Time
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('hi-IN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
        document.getElementById('currentTime').textContent = timeString;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ IMC Attendance Portal loaded');

        // Restore saved phone number if any
        const savedPhone = sessionStorage.getItem('currentPhone');
        if (savedPhone) {
            document.getElementById('phoneNumber').value = savedPhone;
        }

        // Initially update attendance status to reflect disabled button
        updateAttendanceStatus();
    });

    // Handle Enter key press on phone input
    document.addEventListener('DOMContentLoaded', function() {
        const phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
            phoneInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        }
    });

    // Handle page visibility change (pause/resume location monitoring)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            if (locationMonitorInterval) {
                clearInterval(locationMonitorInterval);
                locationMonitorInterval = null;
                console.log('Location monitoring paused (page hidden).');
            }
        } else {
            if (attendanceMarked && originalLat && originalLon) {
                start10MinuteLocationMonitor();
                console.log('Location monitoring resumed (page visible).');
            }
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        if (locationMonitorInterval) {
            clearInterval(locationMonitorInterval);
        }
    });
</script>

</body>
</html>
